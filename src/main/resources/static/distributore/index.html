<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributore Caff√®</title>
    <link rel="stylesheet" href="../css/style.css">

    <!-- SCRIPT GUARDIANO: Protegge l'accesso e gestisce il loop -->
    <script>
        (function() {
            // 1. Fonte di Verit√†: LocalStorage
            const savedCode = localStorage.getItem("distributor_identity");

            // 2. Stato Corrente: URL
            const params = new URLSearchParams(window.location.search);
            const urlCode = params.get("code");

            if (!savedCode) {
                // CASO A: Macchina non inizializzata -> Vai al BOOT
                // Usiamo replace per non lasciare traccia nella history
                window.location.replace("boot.html");
            } else {
                // CASO B: Macchina inizializzata.
                // Verifica coerenza URL (se l'URL non ha il codice, lo aggiungiamo)
                if (urlCode !== savedCode) {
                    window.location.replace("index.html?code=" + encodeURIComponent(savedCode));
                }
                // Se siamo qui, savedCode esiste e l'URL √® corretto. Carichiamo la pagina.
            }
        })();
    </script>

    <style>
        /* Stile schermata Standby */
        .standby-container {
            text-align: center;
            padding: 3rem;
            color: #555;
        }
        .code-display {
            font-size: 3.5rem;
            color: var(--colore-primario);
            font-weight: bold;
            margin: 1rem 0;
            letter-spacing: 2px;
        }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

<header aria-labelledby="distributore-heading">
    <h1 id="distributore-heading">Distributore Automatico UniPA</h1>

    <!-- Tasto nascosto per il Tecnico -->
    <div style="margin-top: 10px;">
        <button id="btn-reset-hardware" type="button" class="btn btn-secondario btn-inline" style="font-size:0.8rem; padding:0.4rem; opacity: 0.7;">
            ‚öôÔ∏è Reset ID(Per cambiare distributore)
        </button>
    </div>
</header>

<main>
    <!-- 1. SCHERMATA STANDBY (Visibile se nessuno √® connesso) -->
    <div id="standby-screen" class="box-sezione standby-container">
        <h2>‚òï Pausa Caff√®?</h2>
        <p>Apri l'app <strong>CoffeeCapp</strong> e connettiti a:</p>

        <div id="display-code-standby" class="code-display">---</div>

        <div class="pulse" style="margin-top: 2rem;">In attesa di connessione...</div>
    </div>

    <!-- 2. SCHERMATA OPERATIVA (Visibile se utente connesso) -->
    <section id="distributor-screen" class="box-sezione" aria-labelledby="dist-header" style="display:none;">

        <h3 id="dist-header">Schermo Operativo</h3>

        <div class="dist-info">
            <p>Utente connesso: <strong id="dist-username">-</strong></p>
            <p>Credito: <strong id="dist-credit" data-value="0">0.00 ‚Ç¨</strong></p>
        </div>

        <form id="purchase-area" style="display:none;" aria-hidden="true">
            <fieldset>
                <legend class="grid-label">Bevanda:</legend>
                <div id="drink-grid">
                    <!-- Popolato via JS -->
                </div>
            </fieldset>

            <label for="sugar-qty">Zucchero:</label>
            <div class="range-wrapper">
                <input type="range" id="sugar-qty" name="sugar" min="0" max="5" value="1"
                       aria-label="Quantit√† zucchero"
                       oninput="this.nextElementSibling.value = this.value">
                <output>1</output>
            </div>

            <button id="btn-purchase" type="button" class="btn">Eroga</button>
        </form>

        <div id="dist-message" role="status" aria-live="polite" class="visually-hidden" data-type="info"></div>
    </section>

    <!-- 3. STATO C: FUORI SERVIZIO (NUOVO) -->
    <div id="maintenance-screen" class="box-sezione" style="display:none; text-align:center; padding:3rem; background-color:#fff0f0; border:2px solid crimson;">
        <h1 style="font-size: 3rem; color: crimson;">üö´ FUORI SERVIZIO</h1>
        <p id="maintenance-msg" style="font-size: 1.5rem; color: #333;">Macchina in manutenzione</p>
        <div style="margin-top: 2rem; font-size: 0.9rem; color: #666;">Codice: <span id="maint-code">---</span></div>
    </div>

    <noscript>
        <div class="noscript-warning">Attenzione: lo script √® disabilitato.</div>
    </noscript>
</main>

<footer>
    <p>Coffee Capp UniPA - Schermo Distributore</p>
</footer>

<script src="../js/apiHelpers.js"></script>
<script src="../js/distributor.poll.js"></script>

<!-- Logica UI Locale (Reset e Display ID) -->
<script>
    // Mostra ID nella standby screen
    const code = localStorage.getItem("distributor_identity");
    if(code) {
        document.getElementById("display-code-standby").textContent = code;
    }

    // Reset Hardware
    document.getElementById("btn-reset-hardware").addEventListener("click", () => {
        if(confirm("ATTENZIONE TECNICO: Vuoi resettare l'identit√† della macchina?")) {
            localStorage.removeItem("distributor_identity");
            window.location.replace("boot.html");
        }
    });
</script>

</body>
</html>